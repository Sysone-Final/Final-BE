# 워크플로우의 이름
name: Spring Boot CI/CD to GCP

# 언제 이 워크플로우를 실행할지 지정
on:
  push:
    branches: [ "main" , "ci/SYSONE-38-backend-deploy" ]

# 실행될 작업들
jobs:
  deploy:
    # 이 작업을 실행할 가상 환경 (Ubuntu 최신 버전)
    runs-on: ubuntu-latest

    # 작업 단계들
    steps:
      # 1. GitHub 레포지토리의 코드를 가상 환경으로 가져오기
      - name: Checkout source code
        uses: actions/checkout@v3

      # 2. Google Cloud 인증하기 (GitHub Secrets 사용)
      - id: 'auth'
        uses: 'google-github-actions/auth@v1'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      # 3. gcloud CLI를 통해 VM에 접속해서 Docker로 배포
      - name: Deploy to Compute Engine with Docker
        run: |
          gcloud compute ssh --zone "${{ secrets.GCP_ZONE }}" "${{ secrets.INSTANCE_NAME }}" \
            --project "${{ secrets.GCP_PROJECT_ID }}" \
            --quiet \
            --command="
              # 프로젝트 폴더가 없으면 새로 클론합니다.
              if [ ! -d /home/sana2d2v/app ]; then
                git clone https://github.com/Sysone-Final/Final-BE.git /home/sana2d2v/app
              fi
          
              # 프로젝트 폴더로 이동합니다.
              cd /home/sana2d2v/app
          
              # 1. GitHub에서 최신 코드를 받아옵니다.
              git pull
          
              # 2. Docker Compose로 애플리케이션을 빌드하고 재시작합니다.
              docker-compose up --build -d
            "